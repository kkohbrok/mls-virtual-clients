<!DOCTYPE html>
<html lang="en" class="Internet-Draft">
<head>
<meta charset="utf-8">
<meta content="Common,Latin" name="scripts">
<meta content="initial-scale=1.0" name="viewport">
<title>MLS Virtual Clients</title>
<meta content="J. Alwen" name="author">
<meta content="Konrad Kohbrok" name="author">
<meta content="Raphael Robert" name="author">
<meta content="
       This document describes a method that allows multiple MLS clients to emulate a
virtual MLS client. A virtual client allows multiple emulator clients to jointly
participate in an MLS group under a single leaf. Depending on the design of the
application, virtual clients can help hide metadata and improve performance. 
    " name="description">
<meta content="xml2rfc 3.18.2" name="generator">
<meta content="Internet-Draft" name="keyword">
<meta content="draft-kohbrok-mls-virtual-clients-latest" name="ietf.draft">
<!-- Generator version information:
  xml2rfc 3.18.2
    Python 3.11.6
    ConfigArgParse 1.7
    google-i18n-address 3.1.0
    intervaltree 3.1.0
    Jinja2 3.1.2
    lxml 4.9.3
    platformdirs 4.1.0
    pycountry 22.3.5
    PyYAML 6.0.1
    requests 2.31.0
    setuptools 68.2.2
    six 1.16.0
    wcwidth 0.2.12
-->
<link href="draft-kohbrok-mls-virtual-clients.xml" rel="alternate" type="application/rfc+xml">
<link href="#copyright" rel="license">
<style type="text/css">@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}

@font-face {
  font-family: 'Lora';
  font-style: italic;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Italic'), local('Lora-Italic'), url('https://martinthomson.github.io/rfc-css/fonts/lora-italic-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Lora Regular'), local('Lora-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/lora-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic-ext.woff2') format('woff2');
  unicode-range: U+0460-052F, U+1C80-1C88, U+20B4, U+2DE0-2DFF, U+A640-A69F, U+FE2E-FE2F;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-cyrillic.woff2') format('woff2');
  unicode-range: U+0400-045F, U+0490-0491, U+04B0-04B1, U+2116;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Lora Bold'), local('Lora-Bold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-bold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Lora';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Lora SemiBold'), local('Lora-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/lora-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-vietnamese.woff2') format('woff2');
  unicode-range: U+0102-0103, U+0110-0111, U+1EA0-1EF9, U+20AB;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Cabin Condensed';
  font-style: normal;
  font-weight: 600;
  font-display: swap;
  src: local('Cabin Condensed SemiBold'), local('CabinCondensed-SemiBold'), url('https://martinthomson.github.io/rfc-css/fonts/cabincondensed-semibold-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin-ext.woff2') format('woff2');
  unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;
}
@font-face {
  font-family: 'Oxygen Mono';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Oxygen Mono'), local('OxygenMono-Regular'), url('https://martinthomson.github.io/rfc-css/fonts/oxygenmono-regular-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

:root {
  color-scheme: light dark;
  --background-color: #fff;
  --text-color: #222;
  --title-color: #191919;
  --link-color: #2a6496;
  --highlight-color: #f9f9f9;
  --line-color: #eee;
  --pilcrow-weak: #ddd;
  --pilcrow-strong: #bbb;
  --small-font-size: 14.5px;
  --font-mono: 'Oxygen Mono', monospace;
  scrollbar-color: #bbb #eee;
}
body {
  max-width: 600px;
  margin: 75px auto;
  padding: 0 5px;
  color: var(--text-color);
  background-color: var(--background-color);
  font: 16px/22px "Lora", serif;
  scroll-behavior: smooth;
}

.ears {
  display: none;
}

/* headings */
h1, h2, h3, h4, h5, h6 {
  font-family: "Cabin Condensed", sans-serif;
  font-weight: 600;
  margin: 0.8em 0 0.3em;
  font-size-adjust: 0.5;
  color: var(--title-color);
}
h1#title {
  font-size: 32px;
  line-height: 40px;
  clear: both;
}
h1#title, h1#rfcnum {
  margin: 1.5em 0 0.2em;
}
h1#rfcnum + h1#title {
  margin: 0.2em 0;
}

h1, h2, h3 {
  font-size: 22px;
  line-height: 27px;
}
h4, h5, h6 {
  font-size: 20px;
  line-height: 24px;
}

/* general structure */
.author {
  padding-bottom: 0.3em;
}
#abstract+p {
  font-size: 18px;
  line-height: 24px;
}
#abstract+p code, #abstract+p samp, #abstract+p tt {
  font-size: 16px;
  line-height: 0;
}

p {
  padding: 0;
  margin: 0.5em 0;
  text-align: left;
}
div {
  margin: 0;
}
.alignRight.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignRight.art-text pre {
  padding: 0;
  width: auto;
}
.alignRight {
  margin: 1em 0;
}
.alignRight > *:first-child {
  border: none;
  margin: 0;
  float: right;
  clear: both;
}
.alignRight > *:nth-child(2) {
  clear: both;
  display: block;
  border: none;
}
svg {
  display: block;
}
/* font-family isn't space-separated, but =~ will have to do */
svg[font-family~="monospace" i], svg [font-family~="monospace" i] {
  font-family: var(--font-mono);
}
.alignCenter.art-text {
  background-color: var(--highlight-color);
  border: 1px solid var(--line-color);
  border-radius: 3px;
  padding: 0.5em 1em 0;
  margin-bottom: 0.5em;
}
.alignCenter.art-text pre {
  padding: 0;
  width: auto;
}
.alignCenter {
  margin: 1em 0;
}
.alignCenter > *:first-child {
  border: none;
  /* this isn't optimal, but it's an existence proof.  PrinceXML doesn't
     support flexbox yet.
  */
  display: table;
  margin: 0 auto;
}

/* lists */
ol, ul {
  padding: 0;
  margin: 0 0 0.5em 2em;
}
:is(ol, ul) :is(ol, ul) {
  margin-left: 1em;
}
li {
  margin: 0 0 0.25em 0;
}
.ulCompact li {
  margin: 0;
}
ul.empty, .ulEmpty {
  list-style-type: none;
}
ul.empty li, .ulEmpty li {
  margin-top: 0.5em;
}
:is(ul, ol).compact, .ulCompact, .olCompact {
  line-height: 1;
  margin: 0 0 0 2em;
}

/* definition lists */
dl {
  clear: left;
  --indent: 3ch;
  /* --indent: attr(indent ch); not supported in any browser, but we can dream */
}
dl.olPercent {
  --indent: 5ch;
}
dl > dt {
  float: left;
  margin-right: 2ch;
  min-width: 8ch;
}
dl.dlNewline > dt {
  float: none;
}
dl > dd {
  margin-bottom: .8em;
  margin-left: var(--indent) !important; /* stupid element overrides */
  min-height: 2ex;
}
dl.olPercent > dt {
  min-width: calc(var(--indent) - 2ch);
}
:is(dl.compact, .dlCompact) > dd {
  margin-bottom: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:first-child, .break:first-child + *) {
  margin-top: 0;
}
:is(dl.compact, .dlCompact) > dd > :is(:last-child) {
  margin-bottom: 0;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0;
}
:is(dd, span).break {
  display: none;
}

/* links */
a, a[href].selfRef:hover {
  text-decoration: none;
}
a[href] {
  color: var(--link-color);
}
a[href].selfRef, .iref + a[href].internal {
  color: var(--text-color);
}
a[href]:hover {
  text-decoration: underline;
}
a[href].selfRef:hover {
  background-color: var(--highlight-color);
}
a.xref:is(.cite, .auto), :is(#status-of-memo, #copyright) a {
  white-space: nowrap;
}

/* Figures */
tt, code, pre {
  background-color: var(--highlight-color);
  font: 14px/22px var(--font-mono);
}
tt, code {
  /* changing the font for inline elements leads to different ascender
     and descender heights; as we want to retain baseline alignment,
     remove leading to avoid altering the final height of lines
     note: this fails if these blocks take an entire line,
     a different solution would be great */
  line-height: 0;
}
:is(h1, h2, h3, h4, h5, h6) :is(tt, code) {
  font-size: 84%;
}
pre {
  border: 1px solid var(--line-color);
  font-size: 13.5px;
  line-height: 16px;
  letter-spacing: -0.2px;
  margin: 5px;
  padding: 5px;
}
img {
  max-width: 100%;
}
figure {
  margin: 0.5em 0;
  padding: 0;
}
figure blockquote {
  margin: 0.8em 0.4em 0.4em;
}
figcaption, caption {
  font-style: italic;
  margin: 0.5em 1.5em;
  text-align: left;
}
@media screen {
  /* Auto-collapse boilerplate. */
  :is(#status-of-memo, #copyright) p {
    margin: -2px 0;
    max-height: 0;
    transition: max-height 2s ease, margin 0.5s ease 0.5s;
    overflow: hidden;
  }
  :is(#status-of-memo, #copyright):hover p,
  :is(#status-of-memo, #copyright) h2:target ~ p {
    margin: 0.5em 0;
    max-height: 500px;
    overflow: auto;
  }
  pre, svg {
    display: inline-block;
    overflow-x: auto;
  }
  pre {
    max-width: 100%;
    width: calc(100% - 22px - 1em);
  }
  svg {
    max-width: calc(100% - 22px - 1em);
  }
  figure pre {
    display: block;
    width: calc(100% - 25px);
  }
  :is(pre, svg) + .pilcrow {
    display: inline-block;
    vertical-align: text-bottom;
    padding-bottom: 8px;
  }
}

/* aside, blockquote */
aside, blockquote {
  margin-left: 0;
  padding: 0 2em;
  font-style: italic;
}
blockquote {
  margin: 1em 0;
}
cite {
  display: block;
  text-align: right;
  font-style: italic;
}

/* tables */
table {
  max-width: 100%;
  margin: 0 0 1em;
  border-collapse: collapse;
}
table.right {
  margin-left: auto;
}
table.center {
  margin-left: auto;
  margin-right: auto;
}
table.left {
  margin-right: auto;
}
thead, tbody {
  border: 1px solid var(--line-color);
}
th, td {
  text-align: left;
  vertical-align: top;
  padding: 5px 10px;
}
th {
  background-color: var(--line-color);
}
:is(tr:nth-child(2n), thead+tbody > tr:nth-child(2n+1)) > td {
  background-color: var(--background-color);
}
:is(tr:nth-child(2n+1), thead+tbody > tr:nth-child(2n)) > td {
  background-color: var(--highlight-color);
}
table caption {
  margin: 0;
  padding: 3px 0 3px 1em;
}
table p {
  margin: 0;
}

/* pilcrow */
a.pilcrow {
  margin-left: 3px;
  opacity: 0.2;
  user-select: none;
}
a.pilcrow[href] { color: var(--pilcrow-weak); }
a.pilcrow[href]:hover { text-decoration: none; }
@media not print {
  :hover > a.pilcrow {
    opacity: 1;
  }
  a.pilcrow[href]:hover {
    color: var(--pilcrow-strong);
    background-color: transparent;
  }
}
@media print {
  a.pilcrow {
    display: none;
  }
}

/* misc */
hr {
  border: 0;
  border-top: 1px solid var(--line-color);
}
.bcp14 {
  font-variant: small-caps;
  font-weight: 600;
  font-size: var(--small-font-size);
}
.role {
  font-variant: all-small-caps;
}
sub, sup {
  line-height: 1;
  font-size: 80%;
}

/* info block */
#identifiers {
  margin: 0;
  font-size: var(--small-font-size);
  line-height: 18px;
  --identifier-width: 15ch;
}
#identifiers dt {
  width: var(--identifier-width);
  min-width: var(--identifier-width);
  clear: left;
  float: left;
  text-align: right;
  margin-right: 1ch;
}
#identifiers dd {
  margin: 0;
  margin-left: calc(1em + var(--identifier-width)) !important;
  min-width: 5em;
}
#identifiers .authors .author {
  display: inline-block;
  margin-right: 1.5em;
}
#identifiers .authors .org {
  font-style: italic;
}

/* The prepared/rendered info at the very bottom of the page */
.docInfo {
  color: #999;
  font-size: 0.9em;
  font-style: italic;
  margin-top: 2em;
}
.docInfo .prepared {
  float: left;
}
.docInfo .prepared {
  float: right;
}

/* table of contents */
#toc {
  padding: 0.75em 0 2em 0;
  margin-bottom: 1em;
}
#toc nav ul {
  margin: 0 0.5em 0 0;
  padding: 0;
  list-style: none;
}
#toc nav li {
  line-height: 1.3em;
  margin: 2px 0;
  padding-left: 1.2em;
  text-indent: -1.2em;
}
#toc a.xref {
  white-space: normal;
}
/* references */
.references dt {
  text-align: right;
  font-weight: bold;
  min-width: 10ch;
  margin-right: 1.5ch;
}
.references dt:target::before {
  content: "⇒";
  width: 15px;
  margin: 0 10px 0 -25px;
}
.references dd {
  margin-left: 12ch !important;
  overflow: auto;
}

.refInstance {
  margin-bottom: 1.25em;
}

.references .ascii {
  margin-bottom: 0.25em;
}

/* index */
#rfc\.index\.index + ul {
  margin-left: 0;
}

/* authors */
address.vcard {
  font-style: normal;
  margin: 1em 0;
}
address.vcard .nameRole {
  font-weight: 700;
  margin-left: 0;
}
address.vcard .label {
  margin: 0.5em 0;
}
address.vcard .type {
  display: none;
}
.alternative-contact {
  margin: 1.5em 0 1em;
}
hr.addr {
  border-top: 1px dashed;
  margin: 0;
  color: #ddd;
  max-width: calc(100% - 16px);
}
@media (min-width: 500px) {
  #authors-addresses > section {
    column-count: 2;
    column-gap: 20px;
  }
  #authors-addresses > section > h2 {
    column-span: all;
  }
  /* hack for break-inside: avoid-column */
  #authors-addresses address {
    display: inline-block;
    break-inside: avoid-column;
  }
}

.rfcEditorRemove p:first-of-type {
  font-style: italic;
}
.cref {
  background-color: rgba(249, 232, 105, 0.3);
  padding: 2px 4px;
}
.crefSource {
  font-style: italic;
}
/* alternative layout for smaller screens */
@media screen and (max-width: 929px) {
  #toc {
    position: fixed;
    z-index: 2;
    top: 0;
    right: 0;
    padding: 1px 0 0 0;
    margin: 0;
    border-bottom: 1px solid #ccc;
    opacity: 0.6;
  }
  #toc.active {
      opacity: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 2px 0 2px 6px;
    padding-right: 1em;
    font-size: 18px;
    line-height: 24px;
    min-width: 190px;
    text-align: right;
    background-color: #444;
    color: white;
    cursor: pointer;
  }
  #toc h2::before { /* css hamburger */
    float: right;
    position: relative;
    width: 1em;
    height: 1px;
    left: -164px;
    margin: 8px 0 0 0;
    background: white none repeat scroll 0 0;
    box-shadow: 0 4px 0 0 white, 0 8px 0 0 white;
    content: "";
  }
  #toc nav {
    display: none;
    background-color: var(--background-color);
    padding: 0.5em 1em 1em;
    overflow: auto;
    overscroll-behavior: contain;
    height: calc(100vh - 48px);
    border-left: 1px solid #ddd;
  }
  #toc.active nav {
    display: block;
  }
  /* Make the collapsed ToC header render white on gray also when it's a link */
  #toc h2 a,
  #toc h2 a:link,
  #toc h2 a:focus,
  #toc h2 a:hover,
  #toc a.toplink,
  #toc a.toplink:hover {
    color: white;
    background-color: #444;
    text-decoration: none;
  }
  #toc a.toplink {
    margin-top: 2px;
  }
}

/* alternative layout for wide screens */
@media screen and (min-width: 930px) {
  body {
    padding-right: 360px;
    padding-right: calc(min(180px + 20%, 500px));
  }
  #toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 480px);
    width: 312px;
    margin: 0;
    padding: 0;
    z-index: 1;
  }
  #toc h2 {
    margin: 0;
    padding: 0.25em 1em 1em 0;
  }
  #toc nav {
    display: block;
    height: calc(90vh - 84px);
    bottom: 0;
    padding: 0.5em 0 2em;
    overflow: auto;
    overscroll-behavior: contain;
    scrollbar-width: thin;
  }
  #toc nav > ul  {
    margin-bottom: 2em;
  }
  #toc ul {
    margin: 0 0 0 4px;
    font-size: var(--small-font-size);
  }
  #toc ul :is(p, li) {
    margin: 2px 0;
    line-height: 22px;
  }
  img { /* future proofing */
    max-width: 100%;
    height: auto;
  }
}

/* pagination */
@media print {
  body {
    width: 100%;
  }
  p {
    orphans: 3;
    widows: 3;
  }
  #n-copyright-notice {
    border-bottom: none;
  }
  #toc, #n-introduction {
    page-break-before: always;
  }
  #toc {
    border-top: none;
    padding-top: 0;
  }
  figure, pre, .vcard {
    page-break-inside: avoid;
  }
  h1, h2, h3, h4, h5, h6 {
    page-break-after: avoid;
  }
  :is(h2, h3, h4, h5, h6)+*, dd {
    page-break-before: avoid;
  }
  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 10pt;
  }
  table {
    border: 1px solid #ddd;
  }
  td {
    border-top: 1px solid #ddd;
  }
  .toplink {
    display: none;
  }
}

@page :first {
  padding-top: 0;
  @top-left {
    content: normal;
    border: none;
  }
  @top-center {
    content: normal;
    border: none;
  }
  @top-right {
    content: normal;
    border: none;
  }
}

@page {
  size: A4;
  margin-bottom: 45mm;
  padding-top: 20px;
}

/* Changes introduced to fix issues found during implementation */

/* Separate body from document info even without intervening H1 */
section {
  clear: both;
}

/* Top align author divs, to avoid names without organization dropping level with org names */
.author {
  vertical-align: top;
}

/* Style section numbers with more space between number and title */
.section-number {
  padding-right: 0.5em;
}

/* Add styling for a link in the ToC that points to the top of the document */
a.toplink {
  float: right;
  margin: 8px 0.5em 0;
}

/* Provide styling for table cell text alignment */
table .text-left {
  text-align: left;
}
table .text-center {
  text-align: center;
}
table .text-right {
  text-align: right;
}

/* Make the alternative author contact information look less like just another
   author, and group it closer with the primary author contact information */
.alternative-contact {
  margin: 0.5em 0 0.25em 0;
}
address .non-ascii {
  margin: 0 0 0 2em;
}

/* With it being possible to set tables with alignment
  left, center, and right, { width: 100%; } does not make sense */
table {
  width: auto;
}

/* Avoid reference text that sits in a block with very wide left margin,
   because of a long floating dt label.*/
.references dd {
  overflow: visible;
}

/* Control caption placement */
caption {
  caption-side: bottom;
}

/* Limit the width of the author address vcard, so names in right-to-left
   script don't end up on the other side of the page. */

address.vcard {
  max-width: 20em;
  margin-right: auto;
}

/* For address alignment dependent on LTR or RTL scripts */
address div.left {
  text-align: left;
}
address div.right {
  text-align: right;
}

/* Dark mode. */
@media (prefers-color-scheme: dark) {
:root {
  --background-color: #121212;
  --text-color: #f0f0f0;
  --title-color: #fff;
  --link-color: #4da4f0;
  --highlight-color: #282828;
  --line-color: #444;
  --pilcrow-weak: #444;
  --pilcrow-strong: #666;
  scrollbar-color: #777 #333;
}
}

/* SVG Trick: a prefix match works because only black and white are allowed */
svg :is([stroke="black"], [stroke^="#000"]) {
  stroke: var(--text-color);
}
svg :is([stroke="white"], [stroke^="#fff"]) {
  stroke: var(--background-color);
}
svg :is([fill="black"], [fill^="#000"], :not([fill])) {
  fill: var(--text-color);
}
svg :is([fill="white"], [fill^="#fff"]) {
  fill: var(--background-color);
}
</style>

</head>
<body class="xml2rfc">
<table class="ears">
<thead><tr>
<td class="left">Internet-Draft</td>
<td class="center">MVC</td>
<td class="right">December 2023</td>
</tr></thead>
<tfoot><tr>
<td class="left">Alwen, et al.</td>
<td class="center">Expires 16 June 2024</td>
<td class="right">[Page]</td>
</tr></tfoot>
</table>
<div id="external-metadata" class="document-information"></div>
<div id="internal-metadata" class="document-information">
<dl id="identifiers">
<dt class="label-workgroup">Workgroup:</dt>
<dd class="workgroup">Network Working Group</dd>
<dt class="label-internet-draft">Internet-Draft:</dt>
<dd class="internet-draft">draft-kohbrok-mls-virtual-clients-latest</dd>
<dt class="label-published">Published:</dt>
<dd class="published">
<time datetime="2023-12-14" class="published">14 December 2023</time>
    </dd>
<dt class="label-intended-status">Intended Status:</dt>
<dd class="intended-status">Informational</dd>
<dt class="label-expires">Expires:</dt>
<dd class="expires"><time datetime="2024-06-16">16 June 2024</time></dd>
<dt class="label-authors">Authors:</dt>
<dd class="authors">
<div class="author">
      <div class="author-name">J. Alwen</div>
</div>
<div class="author">
      <div class="author-name">K. Kohbrok</div>
<div class="org">Phoenix R&amp;D</div>
</div>
<div class="author">
      <div class="author-name">R. Robert</div>
<div class="org">Phoenix R&amp;D</div>
</div>
</dd>
</dl>
</div>
<h1 id="title">MLS Virtual Clients</h1>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract" class="selfRef">Abstract</a></h2>
<p id="section-abstract-1">This document describes a method that allows multiple MLS clients to emulate a
virtual MLS client. A virtual client allows multiple emulator clients to jointly
participate in an MLS group under a single leaf. Depending on the design of the
application, virtual clients can help hide metadata and improve performance.<a href="#section-abstract-1" class="pilcrow">¶</a></p>
</section>
<div id="status-of-memo">
<section id="section-boilerplate.1">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo" class="section-name selfRef">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
        This Internet-Draft is submitted in full conformance with the
        provisions of BCP 78 and BCP 79.<a href="#section-boilerplate.1-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-2">
        Internet-Drafts are working documents of the Internet Engineering Task
        Force (IETF). Note that other groups may also distribute working
        documents as Internet-Drafts. The list of current Internet-Drafts is
        at <span><a href="https://datatracker.ietf.org/drafts/current/">https://datatracker.ietf.org/drafts/current/</a></span>.<a href="#section-boilerplate.1-2" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-3">
        Internet-Drafts are draft documents valid for a maximum of six months
        and may be updated, replaced, or obsoleted by other documents at any
        time. It is inappropriate to use Internet-Drafts as reference
        material or to cite them other than as "work in progress."<a href="#section-boilerplate.1-3" class="pilcrow">¶</a></p>
<p id="section-boilerplate.1-4">
        This Internet-Draft will expire on 16 June 2024.<a href="#section-boilerplate.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="copyright">
<section id="section-boilerplate.2">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice" class="section-name selfRef">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2023 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1" class="pilcrow">¶</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="toc">
<section id="section-toc.1">
        <a href="#" onclick="scroll(0,0)" class="toplink">▲</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents" class="section-name selfRef">Table of Contents</a>
        </h2>
<nav class="toc"><ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1" class="keepWithNext"><a href="#section-1" class="auto internal xref">1</a>.  <a href="#name-introduction" class="internal xref">Introduction</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1" class="keepWithNext"><a href="#section-2" class="auto internal xref">2</a>.  <a href="#name-terminology" class="internal xref">Terminology</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3" class="auto internal xref">3</a>.  <a href="#name-applications" class="internal xref">Applications</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1" class="keepWithNext"><a href="#section-3.1" class="auto internal xref">3.1</a>.  <a href="#name-virtual-clients-for-perform" class="internal xref">Virtual clients for performance</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2" class="auto internal xref">3.2</a>.  <a href="#name-hidden-subgroups" class="internal xref">Hidden subgroups</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3" class="auto internal xref">3.3</a>.  <a href="#name-transparent-subgroups" class="internal xref">Transparent subgroups</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4" class="auto internal xref">4</a>.  <a href="#name-limitations" class="internal xref">Limitations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1" class="auto internal xref">4.1</a>.  <a href="#name-external-remove-proposals" class="internal xref">External remove proposals</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2" class="auto internal xref">4.2</a>.  <a href="#name-external-joins" class="internal xref">External joins</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5" class="auto internal xref">5</a>.  <a href="#name-client-emulation" class="internal xref">Client emulation</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1" class="auto internal xref">5.1</a>.  <a href="#name-generating-virtual-client-s" class="internal xref">Generating Virtual Client Secrets</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2" class="auto internal xref">5.2</a>.  <a href="#name-ds-as-details" class="internal xref">DS/AS Details</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3" class="auto internal xref">5.3</a>.  <a href="#name-adding-emulator-clients" class="internal xref">Adding emulator clients</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.4">
                <p id="section-toc.1-1.5.2.4.1"><a href="#section-5.4" class="auto internal xref">5.4</a>.  <a href="#name-sending-application-message" class="internal xref">Sending application messages</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5">
                <p id="section-toc.1-1.5.2.5.1"><a href="#section-5.5" class="auto internal xref">5.5</a>.  <a href="#name-challenge-based-application" class="internal xref">Challenge-based application message encryption</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5.2.1">
                    <p id="section-toc.1-1.5.2.5.2.1.1"><a href="#section-5.5.1" class="auto internal xref">5.5.1</a>.  <a href="#name-challenge-generation" class="internal xref">Challenge generation</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5.2.2">
                    <p id="section-toc.1-1.5.2.5.2.2.1"><a href="#section-5.5.2" class="auto internal xref">5.5.2</a>.  <a href="#name-message-framing" class="internal xref">Message Framing</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5.2.3">
                    <p id="section-toc.1-1.5.2.5.2.3.1"><a href="#section-5.5.3" class="auto internal xref">5.5.3</a>.  <a href="#name-message-authentication" class="internal xref">Message Authentication</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5.2.4">
                    <p id="section-toc.1-1.5.2.5.2.4.1"><a href="#section-5.5.4" class="auto internal xref">5.5.4</a>.  <a href="#name-content-encryption" class="internal xref">Content Encryption</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5.2.5">
                    <p id="section-toc.1-1.5.2.5.2.5.1"><a href="#section-5.5.5" class="auto internal xref">5.5.5</a>.  <a href="#name-sender-data-encryption" class="internal xref">Sender Data Encryption</a></p>
</li>
                  <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.5.2.6">
                    <p id="section-toc.1-1.5.2.5.2.6.1"><a href="#section-5.5.6" class="auto internal xref">5.5.6</a>.  <a href="#name-forward-secure-kdf" class="internal xref">Forward Secure KDF</a></p>
</li>
                </ul>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.6">
                <p id="section-toc.1-1.5.2.6.1"><a href="#section-5.6" class="auto internal xref">5.6</a>.  <a href="#name-rotation-of-authentication-" class="internal xref">Rotation of authentication key material</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.5.2.7">
                <p id="section-toc.1-1.5.2.7.1"><a href="#section-5.7" class="auto internal xref">5.7</a>.  <a href="#name-example-protocol-flow" class="internal xref">Example protocol flow</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6" class="auto internal xref">6</a>.  <a href="#name-security-considerations" class="internal xref">Security considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7" class="auto internal xref">7</a>.  <a href="#name-privacy-considerations" class="internal xref">Privacy considerations</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8" class="auto internal xref">8</a>.  <a href="#name-performance-considerations" class="internal xref">Performance considerations</a></p>
<ul class="compact toc ulBare ulEmpty">
<li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1" class="auto internal xref">8.1</a>.  <a href="#name-smaller-trees" class="internal xref">Smaller Trees</a></p>
</li>
              <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2" class="auto internal xref">8.2</a>.  <a href="#name-fewer-blanks" class="internal xref">Fewer blanks</a></p>
</li>
            </ul>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9" class="auto internal xref">9</a>.  <a href="#name-emulation-costs" class="internal xref">Emulation costs</a></p>
</li>
          <li class="compact toc ulBare ulEmpty" id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#appendix-A" class="auto internal xref"></a><a href="#name-authors-addresses" class="internal xref">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
</div>
<div id="introduction">
<section id="section-1">
      <h2 id="name-introduction">
<a href="#section-1" class="section-number selfRef">1. </a><a href="#name-introduction" class="section-name selfRef">Introduction</a>
      </h2>
<p id="section-1-1">The MLS protocol facilitates communication between clients, where in an MLS
group, each client is represented by the leaf to which it holds the private key
material. In this document, we propose the notion of a virtual client that is
jointly emulated by a group of emulator clients, where each emulator client
holds the key material necessary to act as the virtual client.<a href="#section-1-1" class="pilcrow">¶</a></p>
<p id="section-1-2">The use of a virtual client allows multiple distinct clients to be represented
by a single leaf in an MLS group. This pattern of shared group membership
provides a new way for applications to structure groups, can improve performance
and help hide group metadata. The effect of the use of virtual clients depends
largely on how it is applied (see <a href="#applications" class="auto internal xref">Section 3</a>).<a href="#section-1-2" class="pilcrow">¶</a></p>
<p id="section-1-3">We discuss technical challenges and propose a concrete scheme that allows a
group of clients to emulate a virtual client that can participate in one or more
MLS groups.<a href="#section-1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="terminology">
<section id="section-2">
      <h2 id="name-terminology">
<a href="#section-2" class="section-number selfRef">2. </a><a href="#name-terminology" class="section-name selfRef">Terminology</a>
      </h2>
<ul class="normal">
<li class="normal" id="section-2-1.1">
          <p id="section-2-1.1.1">Client: Any MLS client including emulator clients, virtual clients and real
clients.<a href="#section-2-1.1.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.2">
          <p id="section-2-1.2.1">Real Client: An MLS client whose secret key material is held by a single
agent.<a href="#section-2-1.2.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.3">
          <p id="section-2-1.3.1">Virtual Client: A client for which the secret key material is held by one or
more other clients, each of which can act on behalf of the virtual client.<a href="#section-2-1.3.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.4">
          <p id="section-2-1.4.1">Emulator Client: A client that collaborates with other emulator clients in
emulating a virtual client. Emulator clients can be real or virtual clients.<a href="#section-2-1.4.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.5">
          <p id="section-2-1.5.1">Heirarchical group: A generalization of an MLS group in which members can be
either virtual or real clients. Heirarchical group members may also act as
emulator clients to collaboratively emulate a virtual client representing the
heirarchical group in one or more other heirarchical groups.<a href="#section-2-1.5.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.6">
          <p id="section-2-1.6.1">Group representative: A group representative of (heirarchical group) G is a
virtual client emulated by the clients in G. The group representative of group
G in another group S is the representative of G that is a member S.<a href="#section-2-1.6.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.7">
          <p id="section-2-1.7.1">Subgroup: A heirarchical group with a representative in one or more other
groups.<a href="#section-2-1.7.1" class="pilcrow">¶</a></p>
</li>
        <li class="normal" id="section-2-1.8">
          <p id="section-2-1.8.1">Supergroup: A heirarchical group with one or more virtual members.<a href="#section-2-1.8.1" class="pilcrow">¶</a></p>
</li>
      </ul>
<p id="section-2-2">TODO: Terminology is up for debate. We’ve sometimes called this “user trees”,
but since there are other use cases, we should choose a more neutral name. For
now, it’s virtual client emulation.<a href="#section-2-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="applications">
<section id="section-3">
      <h2 id="name-applications">
<a href="#section-3" class="section-number selfRef">3. </a><a href="#name-applications" class="section-name selfRef">Applications</a>
      </h2>
<p id="section-3-1">Virtual clients generally allow multiple emulator clients to share membership in
an MLS group, where the virtual client is represented as a single leaf. This is
in contrast to the case where each individual emulator client is a regular
member of the group, each with its own leaf.<a href="#section-3-1" class="pilcrow">¶</a></p>
<p id="section-3-2">Depending on the application, the use of virtual clients can have different
effects. However, in all cases, virtual client emulation introduces a small
amount of overhead for the emulator clients and certain limitations (see
<a href="#limitations" class="auto internal xref">Section 4</a>).<a href="#section-3-2" class="pilcrow">¶</a></p>
<div id="virtual-clients-for-performance">
<section id="section-3.1">
        <h3 id="name-virtual-clients-for-perform">
<a href="#section-3.1" class="section-number selfRef">3.1. </a><a href="#name-virtual-clients-for-perform" class="section-name selfRef">Virtual clients for performance</a>
        </h3>
<p id="section-3.1-1">If a group of emulator clients emulate a virtual client in more than one group,
the overhead caused by the emulation process can be outweighed by two
performance benefits.<a href="#section-3.1-1" class="pilcrow">¶</a></p>
<p id="section-3.1-2">On the one hand, the use of virtual clients makes the higher-level groups (in
which the virtual client is a member) smaller. Instead of one leaf for each
emulator client, it only has a single leaf for the virtual client. As the
complexity of most MLS operations depends on the number of group members, this
increases performance for all members of that group.<a href="#section-3.1-2" class="pilcrow">¶</a></p>
<p id="section-3.1-3">At the same time, the virtual client emulation process (see
<a href="#client-emulation" class="auto internal xref">Section 5</a>) allows emulator clients to carry the benefit of a single
operation in the emulation group to all virtual clients emulated in that group.<a href="#section-3.1-3" class="pilcrow">¶</a></p>
</section>
</div>
<div id="hidden-subgroups">
<section id="section-3.2">
        <h3 id="name-hidden-subgroups">
<a href="#section-3.2" class="section-number selfRef">3.2. </a><a href="#name-hidden-subgroups" class="section-name selfRef">Hidden subgroups</a>
        </h3>
<p id="section-3.2-1">Virtual clients can be used to hide the emulator clients from other members of
higher-level groups. For example, removing group members of the emulator group
will only be visible in the higher-level group as a regular group update.
Similarly, when an emulator client wants to send a message in a higher-level
group, recipients will see the virtual client as the sender and won't be able to
discern which emulator client sent the message, or indeed the fact that the
sender is a virtual client at all.<a href="#section-3.2-1" class="pilcrow">¶</a></p>
<p id="section-3.2-2">Hiding emulator clients behind their virtual client(s) can, for example, hide
the number of devices a human user has, or which device the user is sending
messages from.<a href="#section-3.2-2" class="pilcrow">¶</a></p>
<p id="section-3.2-3">As hiding of emulator clients by design obfuscates the membership in
higher-level groups, it also means that other higher-level group members can't
identify the actual senders and recipients of messages. From the point of view
of other group members, the "end" of the end-to-end encryption and
authentication provided by MLS ends with the virtual client. The relevance of
this fact largely depends on the security goals of the application and the
design of the authentication service.<a href="#section-3.2-3" class="pilcrow">¶</a></p>
<p id="section-3.2-4">If the virtual client is used to hide the emulator clients, the delivery service and
other higher-level group members also lose the ability to enforce policies to
evict stale clients. For example, an emulator client could become stale (i.e.
inactive), while another keeps sending updates. From the point of view of the
higher-level group, the virtual client would remain active.<a href="#section-3.2-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="transparent-subgroups">
<section id="section-3.3">
        <h3 id="name-transparent-subgroups">
<a href="#section-3.3" class="section-number selfRef">3.3. </a><a href="#name-transparent-subgroups" class="section-name selfRef">Transparent subgroups</a>
        </h3>
<p id="section-3.3-1">TODO: The following text assumes that we have some mechanism of adding one or
more additional signatures to MLS messages.<a href="#section-3.3-1" class="pilcrow">¶</a></p>
<p id="section-3.3-2">While applications can choose to use virtual clients to hide the corresponding
emulator clients, they don't have to. When using the virtual client to send
messages, the sending emulator client can provide an addition signature using
either its leaf credential in the emulation group, or another AS-provided
credential that allows higher-level group members to authenticate the message.<a href="#section-3.3-2" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="limitations">
<section id="section-4">
      <h2 id="name-limitations">
<a href="#section-4" class="section-number selfRef">4. </a><a href="#name-limitations" class="section-name selfRef">Limitations</a>
      </h2>
<p id="section-4-1">The use of virtual clients comes with a few limitations when compared to MLS,
where all emulator clients are themselves members of the higher-level groups.<a href="#section-4-1" class="pilcrow">¶</a></p>
<div id="external-remove-proposals">
<section id="section-4.1">
        <h3 id="name-external-remove-proposals">
<a href="#section-4.1" class="section-number selfRef">4.1. </a><a href="#name-external-remove-proposals" class="section-name selfRef">External remove proposals</a>
        </h3>
<p id="section-4.1-1">In some cases, it is desirable for an external sender (e.g. the messaging
provider of a user) to be able to propose the removal of an individual
(non-virtual) client from a group without requiring another client of the same
user to be online. Doing so would allow another client to commit to said remove
proposal and thus remove the client in question from the group.<a href="#section-4.1-1" class="pilcrow">¶</a></p>
<p id="section-4.1-2">This is not possible when using virtual clients. Here, the non-virtual client
would be the emulator client of a virtual client in a higher-level group. While
the server could propose the removal of the client from the emulation group,
this would not effectively remove the client's access to the higher-level groups
in which the virtual client is a member.<a href="#section-4.1-2" class="pilcrow">¶</a></p>
<p id="section-4.1-3">For such a removal to take place, another emulator client would have to be
online to update the key material of the virtual client (in addition to the
removal in the emulation group).<a href="#section-4.1-3" class="pilcrow">¶</a></p>
<p id="section-4.1-4">Another possibility would be for emulator clients to provision KeyPackages for
which only a subset of emulator clients have access to. The external sender
could then propose the removal of the virtual client, coupled with the immediate
addition of a new one using one of the KeyPackages.<a href="#section-4.1-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="external-joins">
<section id="section-4.2">
        <h3 id="name-external-joins">
<a href="#section-4.2" class="section-number selfRef">4.2. </a><a href="#name-external-joins" class="section-name selfRef">External joins</a>
        </h3>
<p id="section-4.2-1">When there are no subgroups and all (emulator) clients are members of each
higher-level group, new (emulator) clients would be able to join via external
commit without influencing the operation of any other emulator client and
without requiring another emulator client to be online.<a href="#section-4.2-1" class="pilcrow">¶</a></p>
<p id="section-4.2-2">When using virtual clients and a client wishes to externally join the emulator
group, it will not have immediate access to the secrets of the virtual clients
associated with that group.<a href="#section-4.2-2" class="pilcrow">¶</a></p>
<p id="section-4.2-3">This can be remedied via one of the following options:<a href="#section-4.2-3" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-4.2-4.1">
            <p id="section-4.2-4.1.1">Another emulator client could provide it with the necessary secrets<a href="#section-4.2-4.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-4.2-4.2">
            <p id="section-4.2-4.2.1">The new emulator client could have the virtual client rejoin all higher-level groups<a href="#section-4.2-4.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
<p id="section-4.2-5">While the first option has the benefit of not requiring an external commit in
any higher-level groups (thus reducing overhead), it either requires another
emulator client to be online to share the necessary secrets directly, or a way
for the new emulator client to retrieve the necessary without the help of
another client. The latter can be achieved, for example, by encrypting the
relevant secrets such that the new client can retrieve and decrypt them.<a href="#section-4.2-5" class="pilcrow">¶</a></p>
<p id="section-4.2-6">The second option on the other hand additionally requires the new emulator
client to re-upload all KeyPackages of the virtual client, thus further
increasing the difficulty of coordinating actions between emulation group and
higher-level groups.<a href="#section-4.2-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="client-emulation">
<section id="section-5">
      <h2 id="name-client-emulation">
<a href="#section-5" class="section-number selfRef">5. </a><a href="#name-client-emulation" class="section-name selfRef">Client emulation</a>
      </h2>
<p id="section-5-1">A set C of emulator clients that want to emulate one or more virtual clients
must first form an MLS heirarchical group G with membership C. The emulator
clients use G to coordinate their shared virtual clients. Just like real
clients, a virtual client V can create, join or participate in any group S, even
acting as an emulator client itself for some other virtual client. If V joins a
group S then this makes G a subgroup of supergroup G where V is called G's
representative in V. G may have 0 or more representatives which can each be a
member of 0 or more supergroups. But G can have at most 1 representative in a
given supergroup. Emulating clients in G MUST ensure that G and all of its
supergroups have distinct group IDs.<a href="#section-5-1" class="pilcrow">¶</a></p>
<p id="section-5-2">An emulator client E in G creates a new virtual client V of G by assigning the V
a fresh virtual client ID (unique among all virtual clients of G) and a
signature key pair. The new creation of V, its ID and key pair are communicated
to rest of G via a commit in G sent by E. As an invariant, emulator client's in
G maintain a copy of the complete local MLS state of V. This includes all MLS
related secrets currently held by V. Using this state, each emulator clients can
independently process MLS messages sent to V to update their copy of V's state.
Emulator client's in G can also act on behalf of V (subject to application
policy) by taking a new action. Possible actions include anything an MLS client
can perform such as generating and publishing a new key packages and sending
commits, proposals, welcome messages or application messages. To help other
members of G update their copies of V's state according to the action, E
anounces the action using a commit to G. Any secrets created by E as part of
implementing the action are generated deterministically by exporting seeds from
G. This allows other emulator clients in G to reproduce the same secrets and
update their own copies of the V's state maintaining the invariant.<a href="#section-5-2" class="pilcrow">¶</a></p>
<p id="section-5-3">OPEN QUESTION: It's also conceivable that emulator clients announce their
actions via application messages. This is sufficient for operations that are
affect individual groups, because the DS of that group will enforce message
ordering.<a href="#section-5-3" class="pilcrow">¶</a></p>
<div id="generating-virtual-client-secrets">
<section id="section-5.1">
        <h3 id="name-generating-virtual-client-s">
<a href="#section-5.1" class="section-number selfRef">5.1. </a><a href="#name-generating-virtual-client-s" class="section-name selfRef">Generating Virtual Client Secrets</a>
        </h3>
<p id="section-5.1-1">An emulator client V in a group G may sample four types of MLS-related secrets
on behalf of a virtual client V which must be reproducable by the other clients
in G: init_key KEM keys in KeyPackage structs, encryption_key KEM keys in
LeafNode structs, path_secrets for an UpdatePath structs and signature key
pairs. In each case, to do this V (and all other clients in G) do this by
constructing an appropriate label for the new secret and exporting from G with
the label.<a href="#section-5.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="dsas-details">
<section id="section-5.2">
        <h3 id="name-ds-as-details">
<a href="#section-5.2" class="section-number selfRef">5.2. </a><a href="#name-ds-as-details" class="section-name selfRef">DS/AS Details</a>
        </h3>
<p id="section-5.2-1">Virtual client emulation should be largely agnostic to specific details of the
AS and DS of the application. However, a few conditions must be met.<a href="#section-5.2-1" class="pilcrow">¶</a></p>
<ul class="normal">
<li class="normal" id="section-5.2-2.1">
            <p id="section-5.2-2.1.1">Access control: All emulator clients must be able to act as the virtual
client, including, for example, queue access and KeyPackage upload<a href="#section-5.2-2.1.1" class="pilcrow">¶</a></p>
</li>
          <li class="normal" id="section-5.2-2.2">
            <p id="section-5.2-2.2.1">Queue compatibility: The queue system must allow all emulator clients to
retrieve messages for the virtual clients. (Although workarounds like one
emulator client retrieving messages and then sending them to the emulation
group are possible.)<a href="#section-5.2-2.2.1" class="pilcrow">¶</a></p>
</li>
        </ul>
</section>
</div>
<div id="adding-emulator-clients">
<section id="section-5.3">
        <h3 id="name-adding-emulator-clients">
<a href="#section-5.3" class="section-number selfRef">5.3. </a><a href="#name-adding-emulator-clients" class="section-name selfRef">Adding emulator clients</a>
        </h3>
<p id="section-5.3-1">If a client is added to the emulation group, it has to be provisioned with the
private key material and the group states of all higher-level groups. While the
latter might be able to be provisioned by the higher-level DS, the former has to
be provided by another emulator client.<a href="#section-5.3-1" class="pilcrow">¶</a></p>
<p id="section-5.3-2">The other emulator client can provide the secret key material used to derive all
key material relevant to the virtual client (higher-level group secrets,
KeyPackage secrets, etc.)<a href="#section-5.3-2" class="pilcrow">¶</a></p>
<p id="section-5.3-3">TODO: This means that all such key material must be derived in a well-separated
and forward-secure way. (See TODO above to specify further details on how to
derive key material for the virtual client.)<a href="#section-5.3-3" class="pilcrow">¶</a></p>
<p id="section-5.3-4">Since the new emulator client can only emulate the virtual client if it has
access to those secrets, it cannot join the emulation group via external commit,
except if said secrets are provided asynchronously.<a href="#section-5.3-4" class="pilcrow">¶</a></p>
</section>
</div>
<div id="sending-application-messages">
<section id="section-5.4">
        <h3 id="name-sending-application-message">
<a href="#section-5.4" class="section-number selfRef">5.4. </a><a href="#name-sending-application-message" class="section-name selfRef">Sending application messages</a>
        </h3>
<p id="section-5.4-1">MLS applications messages are encrypted using key material derived from the
secret tree, where a unique key/nonce pair is derived for each message and
irrevocably deleted after the message was encrypted or decrypted.<a href="#section-5.4-1" class="pilcrow">¶</a></p>
<p id="section-5.4-2">This poses a problem in the context of virtual client emulation, because the use
of such key material cannot easily be coordinated between emulating clients.
However, reusing a key/nonce pair for different application messages leaks
information about the plaintexts. Moreover, any client receving the two would
not be able to decrypt the second message as the requisit key would already
be deleted.<a href="#section-5.4-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="challenge-based-application-message-encryption">
<section id="section-5.5">
        <h3 id="name-challenge-based-application">
<a href="#section-5.5" class="section-number selfRef">5.5. </a><a href="#name-challenge-based-application" class="section-name selfRef">Challenge-based application message encryption</a>
        </h3>
<p id="section-5.5-1">This problem can be solved by introducing a new type of application message
where the encryption keys are derived using a challenge-based approach.<a href="#section-5.5-1" class="pilcrow">¶</a></p>
<p id="section-5.5-2">Using a forward-secret exporter secret (provided by the safe extension API),
each member creates a new secret tree. Whenever a group member wants to send a
message, it creates a fresh random challenge (see <a href="#challenge-generation" class="auto internal xref">Section 5.5.1</a>) for
that message. Each challenge is mapped to its own secret using a forward-secure
KDF implimented using a new secret tree (see <a href="#forward-secure-kdf" class="auto internal xref">Section 5.5.6</a>). The secret
is used to derive the key/nonce used to encrypt a message. The sender includes
the challenge in the AAD of the application message so that receivers can also
derive the decryption key. Finally, to ensure forward secrecy of the
challenge-based application message both sender and recipients apply the same
deletion schedule as for the standard secret tree in normal MLS.<a href="#section-5.5-2" class="pilcrow">¶</a></p>
<div id="challenge-generation">
<section id="section-5.5.1">
          <h4 id="name-challenge-generation">
<a href="#section-5.5.1" class="section-number selfRef">5.5.1. </a><a href="#name-challenge-generation" class="section-name selfRef">Challenge generation</a>
          </h4>
<p id="section-5.5.1-1">To send an application message the sender must first sample a challenge. It is
crucial for application message confidentiality that challenges have high
entropy and are never used more than once. The following method for sampling
challenges ensures this by introducing sufficient entropy and guaranting that
two challenges can only ever be the same if they are sampled by the same sender,
in the same epoch, for the same message generation using the same entropy.<a href="#section-5.5.1-1" class="pilcrow">¶</a></p>
<p id="section-5.5.1-2">For each epoch in which a client wants to send challenge-based application
messages it maintains a local uint32 message generation counter for the epoch.
The counter is initilized to 0 and incremented after each challenge is sampled.
If the counter wraps around to 0 then all subsequent attempts by the client to
send in the epoch MUST result in a failure.<a href="#section-5.5.1-2" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.1-3">
<pre>
uint32 generation;
</pre><a href="#section-5.5.1-3" class="pilcrow">¶</a>
</div>
<p id="section-5.5.1-4">To sample a challenge the sender first samples AEAD.Nk uniform random octets
called the challenge-seed. Next the they populate a ChallengeContext including
their leaf index in the group in which the message is sent, the current
generation counter and the confirmation tag of the current epoch (which in turn
contains the hashed group context).<a href="#section-5.5.1-4" class="pilcrow">¶</a></p>
<p id="section-5.5.1-5">Additionally, the sender also includes their leaf index and the confirmation tag
of each hierarchical group between the sending (virtual) client and the real
client that actually samples the entropy.<a href="#section-5.5.1-5" class="pilcrow">¶</a></p>
<p id="section-5.5.1-6">The application may supply further context in the applicaiton_context field.
Finally, the challenge is derived from the challenge-seed and ChallengeContext
using the FS-KDF and the generation counter is incremented.<a href="#section-5.5.1-6" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.1-7">
<pre>
struct {
  optional&lt;GroupChallengeContext&gt; subgroup_context;
  uint32 leaf_index;
  MAC confirmation_tag;
} GroupChallengeContext

struct {
  GroupChallengeContext group_challenge_context;
  uint32 generation;
  opaque application_context&lt;V&gt;;
} ChallengeContext

challenge = FS-KDF.Expand(challenge-seed, ChallengeContext, KDF.Nh)
</pre><a href="#section-5.5.1-7" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="message-framing">
<section id="section-5.5.2">
          <h4 id="name-message-framing">
<a href="#section-5.5.2" class="section-number selfRef">5.5.2. </a><a href="#name-message-framing" class="section-name selfRef">Message Framing</a>
          </h4>
<p id="section-5.5.2-1">The following enum and structs define the wire format for challenge-based
application messages.<a href="#section-5.5.2-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.2-2">
<pre>
struct {
  opaque challenge&lt;V&gt;;
  uint32 sender_index;
} CBAMSender;

struct {
    ProtocolVersion version = mls10;
    WireFormat wire_format;
    CBAMPrivateMessage private_message;
} CBAMMLSMessage;
</pre><a href="#section-5.5.2-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="message-authentication">
<section id="section-5.5.3">
          <h4 id="name-message-authentication">
<a href="#section-5.5.3" class="section-number selfRef">5.5.3. </a><a href="#name-message-authentication" class="section-name selfRef">Message Authentication</a>
          </h4>
<p id="section-5.5.3-1">The following structs are used to authenticate data in a challenge-based
application message.<a href="#section-5.5.3-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.3-2">
<pre>
// See the "MLS Wire Formats" IANA registry for values
uint16 WireFormat;

struct {
  opaque group_id&lt;V&gt;;
  uint64 epoch;
  CBAMSender sender;
  opaque authenticated_data&lt;V&gt;;
  opaque application_data&lt;V&gt;;
} CBAMFramedContent

struct {
  ProtocolVersion version = mls10;
  WireFormat wire_format;
  CBAMFramedContent content;
  GroupContext context;
} CBAMFramedContentTBS;

struct {
  /* SignWithLabel(., "CBAMFramedContentTBS", CBAMFramedContentTBS) */
  opaque signature&lt;V&gt;;
} CBAMFramedContentAuthData;

struct {
  WireFormat wire_format;
  CBAMFramedContent content;
  CBAMFramedContentAuthData auth_data;
} CBAMAuthenticatedContent;

</pre><a href="#section-5.5.3-2" class="pilcrow">¶</a>
</div>
<p id="section-5.5.3-3">Challenge-based application messages are encoded, authenticated and encrypted
much like MLS private messages using the CBAMPrivateMessage struct.<a href="#section-5.5.3-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.3-4">
<pre>
struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    opaque authenticated_data&lt;V&gt;;
    opaque encrypted_cbam_sender_data&lt;V&gt;;
    opaque cbam_encrypted_cbam_private_message_content&lt;V&gt;;
} CBAMPrivateMessage;
</pre><a href="#section-5.5.3-4" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="content-encryption">
<section id="section-5.5.4">
          <h4 id="name-content-encryption">
<a href="#section-5.5.4" class="section-number selfRef">5.5.4. </a><a href="#name-content-encryption" class="section-name selfRef">Content Encryption</a>
          </h4>
<p id="section-5.5.4-1">Content to be encrypted is encoded with a CBAMPrivateMessageContent and the
Additional Authenticated data is encoded with a CBAMPrivateContentAAD. The key
and nonce used for encryption are derived from the encryption_secret and the
challenge C using the challenge-based secret tree as described in
<a href="#forward-secure-kdf" class="auto internal xref">Section 5.5.6</a>.<a href="#section-5.5.4-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.4-2">
<pre>
struct {
  opaque application_data&lt;V&gt;;
  CBAMFramedContentAuthData auth_data;
  opaque padding[length_of_padding];
} CBAMPrivateMessageContent;

struct {
  opaque group_id&lt;V&gt;;
  uint64 epoch;
  opaque cbam_authenticated_data&lt;V&gt;;
} CBMAPrivateContentAAD;

aead_key = aead_key[C]

aead_nonce = aead_nonce[C]
</pre><a href="#section-5.5.4-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="sender-data-encryption">
<section id="section-5.5.5">
          <h4 id="name-sender-data-encryption">
<a href="#section-5.5.5" class="section-number selfRef">5.5.5. </a><a href="#name-sender-data-encryption" class="section-name selfRef">Sender Data Encryption</a>
          </h4>
<p id="section-5.5.5-1">The encrypted_cbam_sender_data is obtained by encrypting the CBAMSenderData
using keys derived from the cbam_sender_data_secret. This secret is exported
using the safe API's forward-secure exporter function MLS-FS-Exporter using the
label "CBAM Sender Data Secret" and an empty context. Other than that, the same
method is used to encrypt sender data as for standard application messages.<a href="#section-5.5.5-1" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.5-2">
<pre>
cbam_sender_data_secret = MLS-FS-Export("CBAM Sender Data Secret", "", KDF.Nk)

ciphertext_sample = ciphertext[0..KDF.Nh-1]

sender_data_key = ExpandWithLabel(cbam_sender_data_secret, "key",
                      ciphertext_sample, AEAD.Nk)
sender_data_nonce = ExpandWithLabel(cbam_sender_data_secret, "nonce",
                      ciphertext_sample, AEAD.Nn)
</pre><a href="#section-5.5.5-2" class="pilcrow">¶</a>
</div>
</section>
</div>
<div id="forward-secure-kdf">
<section id="section-5.5.6">
          <h4 id="name-forward-secure-kdf">
<a href="#section-5.5.6" class="section-number selfRef">5.5.6. </a><a href="#name-forward-secure-kdf" class="section-name selfRef">Forward Secure KDF</a>
          </h4>
<p id="section-5.5.6-1">A consequence of the secret tree structure in MLS is that deriving the key/nonce
for a given application message requires knowing the leaf node of the client.<a href="#section-5.5.6-1" class="pilcrow">¶</a></p>
<p id="section-5.5.6-2">The symmetric ratchets in MLS require performing as many (KDF and storage)
operations as application messages are being skipped. The challenge-based secret
tree (CBST) described in this section avoids these issues. Like the secret tree
in MLS, it consists of a binary tree of secrets. However, leaves are indexed by
challenges instead of leaf nodes which means the tree now has depth KDF.Nh.<a href="#section-5.5.6-2" class="pilcrow">¶</a></p>
<p id="section-5.5.6-3">Nodes in the CBST are identified by the string encoding the path from the root
to the node. The root is identified by the empty string "". If a node is
identified by string <code>N</code> then its left child is identified the string <code>N||0</code> and
the right child by the string <code>N||1</code>. Each node is assigned a secret. The root
is assigned the cbam_encryption_secret which is exported from the MLS session
using the safe API's FS-Export function. All other nodes in the CBST are
assigned a secrety by applying ExpandWithLabel to its parents secret with
appropriate labels.<a href="#section-5.5.6-3" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.6-4">
<pre>
cbst_encryption_secret = MLS-FS-Export("CBST", "", KDF.Nh)

cbst_tree_node_[""]_secret = cbst_encryption_secret

cbst_tree_node_[N]_secret
        |
        |
        +--&gt; ExpandWithLabel(., "CBST", "left", KDF.Nh)
        |    = cbst_tree_node_[left(N)]_secret
        |
        +--&gt; ExpandWithLabel(., "CBST", "right", KDF.Nh)
             = cbst_tree_node_[right(N)]_secret
</pre><a href="#section-5.5.6-4" class="pilcrow">¶</a>
</div>
<p id="section-5.5.6-5">The key and nonce for a KDF.Nh octet long challenge C are derived from the
secret for leaf node identified by C.<a href="#section-5.5.6-5" class="pilcrow">¶</a></p>
<div class="alignLeft art-text artwork" id="section-5.5.6-6">
<pre>
aead_key[C] = ExpandWithLabel(cbst_tree_node[C]_secret, "CBST", "key", KDF.Nh)

nonce_key[C] = ExpandWithLabel(cbst_tree_node[C]_secret, "CBST", "nonce",
KDF.Nh)
</pre><a href="#section-5.5.6-6" class="pilcrow">¶</a>
</div>
<p id="section-5.5.6-7">The same deletion schedule applies to the CBST (including the
cbst_encryption_secret) as for the secret tree in MLS.<a href="#section-5.5.6-7" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="rotation-of-authentication-key-material">
<section id="section-5.6">
        <h3 id="name-rotation-of-authentication-">
<a href="#section-5.6" class="section-number selfRef">5.6. </a><a href="#name-rotation-of-authentication-" class="section-name selfRef">Rotation of authentication key material</a>
        </h3>
<p id="section-5.6-1">If the design of the AS specifies the use of cross-group authentication key
material, emulator clients must coordinate the rotation of said key material in
the emulation group to avoid multiple emulator clients rotating a key at the
same time. Details depend on the design of the AS.<a href="#section-5.6-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="example-protocol-flow">
<section id="section-5.7">
        <h3 id="name-example-protocol-flow">
<a href="#section-5.7" class="section-number selfRef">5.7. </a><a href="#name-example-protocol-flow" class="section-name selfRef">Example protocol flow</a>
        </h3>
<p id="section-5.7-1">Virtual clients can, for example, be used by users with multiple devices. Here,
each device acts as an emulator client that emulates the virtual client which
represents Alice towards other users.<a href="#section-5.7-1" class="pilcrow">¶</a></p>
<p id="section-5.7-2">A group with Alice and Bob would thus still only have two members, regardless of
the number of clients Alice and Bob have.<a href="#section-5.7-2" class="pilcrow">¶</a></p>
<p id="section-5.7-3">Each of Alice's devices would thus keep the state of one emulator client, as
well as the virtual client jointly emulated by all of Alice's clients.<a href="#section-5.7-3" class="pilcrow">¶</a></p>
<p id="section-5.7-4">If one of Alice's devices wanted to update its key material to achieve
post-compromise security, it would first perform a commit in the emulation
group, both to signal the action to other emulator clients and to update the key
material from which the randomness for the virtual client is sampled. From the
updated emulation group, the emulator client would then export the randomness to
perform an update in each group in which Alice (through the virtual client) is a
member.<a href="#section-5.7-4" class="pilcrow">¶</a></p>
<p id="section-5.7-5">Alice's other clients would receive and process the commit in the emulation
group. Using the information included about the virtual client operation, they
also update their virtual client state.<a href="#section-5.7-5" class="pilcrow">¶</a></p>
<p id="section-5.7-6">Bob (or other members in the higher level group) will only see the update in the
higher-level group, which they can simply process with their (virtual) clients.<a href="#section-5.7-6" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="security-considerations">
<section id="section-6">
      <h2 id="name-security-considerations">
<a href="#section-6" class="section-number selfRef">6. </a><a href="#name-security-considerations" class="section-name selfRef">Security considerations</a>
      </h2>
<p id="section-6-1">TODO: Detail security considerations once the protocol has evolved a little
more. Starting points:<a href="#section-6-1" class="pilcrow">¶</a></p>
<p id="section-6-2">Some of the performance benefits of this scheme depend on the fact that one can
update once in the emulation group and “re-use” the new randomness for updates
in multiple higher-level groups. At that point, clients only really recover when
they update the emulation group, i.e. re-using somewhat old randomness of the
emulation group won’t provide real PCS in higher-level groups.<a href="#section-6-2" class="pilcrow">¶</a></p>
</section>
</div>
<div id="privacy-considerations">
<section id="section-7">
      <h2 id="name-privacy-considerations">
<a href="#section-7" class="section-number selfRef">7. </a><a href="#name-privacy-considerations" class="section-name selfRef">Privacy considerations</a>
      </h2>
<p id="section-7-1">TODO: Specify the metadata hiding properties of the protocol. The details depend
on how we solve some of the problems described throughout this document.
However, using a virtual client should mask add/remove activity in the
underlying emulation group. If it actually hides the identity of the members may
depend on the details of the AS, as well as how we solve the application
messages problem.<a href="#section-7-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="performance-considerations">
<section id="section-8">
      <h2 id="name-performance-considerations">
<a href="#section-8" class="section-number selfRef">8. </a><a href="#name-performance-considerations" class="section-name selfRef">Performance considerations</a>
      </h2>
<p id="section-8-1">There are several use cases, where a specific group of clients represents a
higher-level entity such as a user, or a part of an organization. If that group
of clients shares membership in a large number of groups, where its sole purpose
is to represent the higher-level entity, then instead emulating a virtual client
can yield a number of performance benefits, especially if this strategy is
employed across an implementation. Generally, the more emulator clients are
hidden behind a single virtual client and the more clients are replaced by
virtual clients, the higher the potential performance benefits.<a href="#section-8-1" class="pilcrow">¶</a></p>
<div id="smaller-trees">
<section id="section-8.1">
        <h3 id="name-smaller-trees">
<a href="#section-8.1" class="section-number selfRef">8.1. </a><a href="#name-smaller-trees" class="section-name selfRef">Smaller Trees</a>
        </h3>
<p id="section-8.1-1">As a general rule, groups where one or more sets of clients are replaced by
virtual clients have fewer members, which leads to cheaper MLS operations where
the cost depends on the group size, e.g., commits with a path, the download size
of the group state for new members, etc. This increase in performance can offset
performance penalties, for example, when using a PQ-secure cipher suite, or if
the application requires high update frequencies (deniability).<a href="#section-8.1-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="fewer-blanks">
<section id="section-8.2">
        <h3 id="name-fewer-blanks">
<a href="#section-8.2" class="section-number selfRef">8.2. </a><a href="#name-fewer-blanks" class="section-name selfRef">Fewer blanks</a>
        </h3>
<p id="section-8.2-1">Blanks are typically created in the process of client removals. With virtual
clients, the removal of an emulator client will not cause the leaf of the
virtual client (or indeed any node in the virtual client’s direct path) to be
blanked, except if it is the last remaining emulator client. As a result,
fluctuation in emulator clients does not necessarily lead to blanks in the group
of the corresponding virtual clients, resulting in fewer overall blanks and
better performance for all group members.<a href="#section-8.2-1" class="pilcrow">¶</a></p>
</section>
</div>
</section>
</div>
<div id="emulation-costs">
<section id="section-9">
      <h2 id="name-emulation-costs">
<a href="#section-9" class="section-number selfRef">9. </a><a href="#name-emulation-costs" class="section-name selfRef">Emulation costs</a>
      </h2>
<p id="section-9-1">From a performance standpoint, using virtual clients only makes sense if the
performance benefits from smaller trees and fewer blanks outweigh the
performance overhead incurred by emulating the virtual client in the first
place.<a href="#section-9-1" class="pilcrow">¶</a></p>
</section>
</div>
<div id="authors-addresses">
<section id="appendix-A">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses" class="section-name selfRef">Authors' Addresses</a>
      </h2>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">J. Alwen</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:alwenjo@amazon.com" class="email">alwenjo@amazon.com</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Konrad Kohbrok</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:konrad.kohbrok@datashrine.de" class="email">konrad.kohbrok@datashrine.de</a>
</div>
</address>
<address class="vcard">
        <div dir="auto" class="left"><span class="fn nameRole">Raphael Robert</span></div>
<div dir="auto" class="left"><span class="org">Phoenix R&amp;D</span></div>
<div class="email">
<span>Email:</span>
<a href="mailto:ietf@raphaelrobert.com" class="email">ietf@raphaelrobert.com</a>
</div>
</address>
</section>
</div>
<script>const toc = document.getElementById("toc");
toc.querySelector("h2").addEventListener("click", e => {
  toc.classList.toggle("active");
});
toc.querySelector("nav").addEventListener("click", e => {
  toc.classList.remove("active");
});
</script>
</body>
</html>
